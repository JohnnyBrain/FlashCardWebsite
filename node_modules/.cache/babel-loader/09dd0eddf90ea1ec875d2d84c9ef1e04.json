{"ast":null,"code":"/**\n * Manage access to data, be it to find, update or remove it\n */\nvar model = require('./model'),\n    _ = require('underscore');\n/**\n * Create a new cursor for this collection\n * @param {Datastore} db - The datastore this cursor is bound to\n * @param {Query} query - The query this cursor will operate on\n * @param {Function} execFn - Handler to be executed after cursor has found the results and before the callback passed to find/findOne/update/remove\n */\n\n\nfunction Cursor(db, query, execFn) {\n  this.db = db;\n  this.query = query || {};\n\n  if (execFn) {\n    this.execFn = execFn;\n  }\n}\n/**\n * Set a limit to the number of results\n */\n\n\nCursor.prototype.limit = function (limit) {\n  this._limit = limit;\n  return this;\n};\n/**\n * Skip a the number of results\n */\n\n\nCursor.prototype.skip = function (skip) {\n  this._skip = skip;\n  return this;\n};\n/**\n * Sort results of the query\n * @param {SortQuery} sortQuery - SortQuery is { field: order }, field can use the dot-notation, order is 1 for ascending and -1 for descending\n */\n\n\nCursor.prototype.sort = function (sortQuery) {\n  this._sort = sortQuery;\n  return this;\n};\n/**\n * Add the use of a projection\n * @param {Object} projection - MongoDB-style projection. {} means take all fields. Then it's { key1: 1, key2: 1 } to take only key1 and key2\n *                              { key1: 0, key2: 0 } to omit only key1 and key2. Except _id, you can't mix takes and omits\n */\n\n\nCursor.prototype.projection = function (projection) {\n  this._projection = projection;\n  return this;\n};\n/**\n * Apply the projection\n */\n\n\nCursor.prototype.project = function (candidates) {\n  var res = [],\n      self = this,\n      keepId,\n      action,\n      keys;\n\n  if (this._projection === undefined || Object.keys(this._projection).length === 0) {\n    return candidates;\n  }\n\n  keepId = this._projection._id === 0 ? false : true;\n  this._projection = _.omit(this._projection, '_id'); // Check for consistency\n\n  keys = Object.keys(this._projection);\n  keys.forEach(function (k) {\n    if (action !== undefined && self._projection[k] !== action) {\n      throw new Error(\"Can't both keep and omit fields except for _id\");\n    }\n\n    action = self._projection[k];\n  }); // Do the actual projection\n\n  candidates.forEach(function (candidate) {\n    var toPush;\n\n    if (action === 1) {\n      // pick-type projection\n      toPush = {\n        $set: {}\n      };\n      keys.forEach(function (k) {\n        toPush.$set[k] = model.getDotValue(candidate, k);\n\n        if (toPush.$set[k] === undefined) {\n          delete toPush.$set[k];\n        }\n      });\n      toPush = model.modify({}, toPush);\n    } else {\n      // omit-type projection\n      toPush = {\n        $unset: {}\n      };\n      keys.forEach(function (k) {\n        toPush.$unset[k] = true;\n      });\n      toPush = model.modify(candidate, toPush);\n    }\n\n    if (keepId) {\n      toPush._id = candidate._id;\n    } else {\n      delete toPush._id;\n    }\n\n    res.push(toPush);\n  });\n  return res;\n};\n/**\n * Get all matching elements\n * Will return pointers to matched elements (shallow copies), returning full copies is the role of find or findOne\n * This is an internal function, use exec which uses the executor\n *\n * @param {Function} callback - Signature: err, results\n */\n\n\nCursor.prototype._exec = function (_callback) {\n  var res = [],\n      added = 0,\n      skipped = 0,\n      self = this,\n      error = null,\n      i,\n      keys,\n      key;\n\n  function callback(error, res) {\n    if (self.execFn) {\n      return self.execFn(error, res, _callback);\n    } else {\n      return _callback(error, res);\n    }\n  }\n\n  this.db.getCandidates(this.query, function (err, candidates) {\n    if (err) {\n      return callback(err);\n    }\n\n    try {\n      for (i = 0; i < candidates.length; i += 1) {\n        if (model.match(candidates[i], self.query)) {\n          // If a sort is defined, wait for the results to be sorted before applying limit and skip\n          if (!self._sort) {\n            if (self._skip && self._skip > skipped) {\n              skipped += 1;\n            } else {\n              res.push(candidates[i]);\n              added += 1;\n\n              if (self._limit && self._limit <= added) {\n                break;\n              }\n            }\n          } else {\n            res.push(candidates[i]);\n          }\n        }\n      }\n    } catch (err) {\n      return callback(err);\n    } // Apply all sorts\n\n\n    if (self._sort) {\n      keys = Object.keys(self._sort); // Sorting\n\n      var criteria = [];\n\n      for (i = 0; i < keys.length; i++) {\n        key = keys[i];\n        criteria.push({\n          key: key,\n          direction: self._sort[key]\n        });\n      }\n\n      res.sort(function (a, b) {\n        var criterion, compare, i;\n\n        for (i = 0; i < criteria.length; i++) {\n          criterion = criteria[i];\n          compare = criterion.direction * model.compareThings(model.getDotValue(a, criterion.key), model.getDotValue(b, criterion.key), self.db.compareStrings);\n\n          if (compare !== 0) {\n            return compare;\n          }\n        }\n\n        return 0;\n      }); // Applying limit and skip\n\n      var limit = self._limit || res.length,\n          skip = self._skip || 0;\n      res = res.slice(skip, skip + limit);\n    } // Apply projection\n\n\n    try {\n      res = self.project(res);\n    } catch (e) {\n      error = e;\n      res = undefined;\n    }\n\n    return callback(error, res);\n  });\n};\n\nCursor.prototype.exec = function () {\n  this.db.executor.push({\n    this: this,\n    fn: this._exec,\n    arguments: arguments\n  });\n}; // Interface\n\n\nmodule.exports = Cursor;","map":{"version":3,"names":["model","require","_","Cursor","db","query","execFn","prototype","limit","_limit","skip","_skip","sort","sortQuery","_sort","projection","_projection","project","candidates","res","self","keepId","action","keys","undefined","Object","length","_id","omit","forEach","k","Error","candidate","toPush","$set","getDotValue","modify","$unset","push","_exec","_callback","added","skipped","error","i","key","callback","getCandidates","err","match","criteria","direction","a","b","criterion","compare","compareThings","compareStrings","slice","e","exec","executor","this","fn","arguments","module","exports"],"sources":["/Users/johnbrain/Projects/FlashCardProject/node_modules/nedb/lib/cursor.js"],"sourcesContent":["/**\n * Manage access to data, be it to find, update or remove it\n */\nvar model = require('./model')\n  , _ = require('underscore')\n  ;\n\n\n\n/**\n * Create a new cursor for this collection\n * @param {Datastore} db - The datastore this cursor is bound to\n * @param {Query} query - The query this cursor will operate on\n * @param {Function} execFn - Handler to be executed after cursor has found the results and before the callback passed to find/findOne/update/remove\n */\nfunction Cursor (db, query, execFn) {\n  this.db = db;\n  this.query = query || {};\n  if (execFn) { this.execFn = execFn; }\n}\n\n\n/**\n * Set a limit to the number of results\n */\nCursor.prototype.limit = function(limit) {\n  this._limit = limit;\n  return this;\n};\n\n\n/**\n * Skip a the number of results\n */\nCursor.prototype.skip = function(skip) {\n  this._skip = skip;\n  return this;\n};\n\n\n/**\n * Sort results of the query\n * @param {SortQuery} sortQuery - SortQuery is { field: order }, field can use the dot-notation, order is 1 for ascending and -1 for descending\n */\nCursor.prototype.sort = function(sortQuery) {\n  this._sort = sortQuery;\n  return this;\n};\n\n\n/**\n * Add the use of a projection\n * @param {Object} projection - MongoDB-style projection. {} means take all fields. Then it's { key1: 1, key2: 1 } to take only key1 and key2\n *                              { key1: 0, key2: 0 } to omit only key1 and key2. Except _id, you can't mix takes and omits\n */\nCursor.prototype.projection = function(projection) {\n  this._projection = projection;\n  return this;\n};\n\n\n/**\n * Apply the projection\n */\nCursor.prototype.project = function (candidates) {\n  var res = [], self = this\n    , keepId, action, keys\n    ;\n\n  if (this._projection === undefined || Object.keys(this._projection).length === 0) {\n    return candidates;\n  }\n\n  keepId = this._projection._id === 0 ? false : true;\n  this._projection = _.omit(this._projection, '_id');\n\n  // Check for consistency\n  keys = Object.keys(this._projection);\n  keys.forEach(function (k) {\n    if (action !== undefined && self._projection[k] !== action) { throw new Error(\"Can't both keep and omit fields except for _id\"); }\n    action = self._projection[k];\n  });\n\n  // Do the actual projection\n  candidates.forEach(function (candidate) {\n    var toPush;\n    if (action === 1) {   // pick-type projection\n      toPush = { $set: {} };\n      keys.forEach(function (k) {\n        toPush.$set[k] = model.getDotValue(candidate, k);\n        if (toPush.$set[k] === undefined) { delete toPush.$set[k]; }\n      });\n      toPush = model.modify({}, toPush);\n    } else {   // omit-type projection\n      toPush = { $unset: {} };\n      keys.forEach(function (k) { toPush.$unset[k] = true });\n      toPush = model.modify(candidate, toPush);\n    }\n    if (keepId) {\n      toPush._id = candidate._id;\n    } else {\n      delete toPush._id;\n    }\n    res.push(toPush);\n  });\n\n  return res;\n};\n\n\n/**\n * Get all matching elements\n * Will return pointers to matched elements (shallow copies), returning full copies is the role of find or findOne\n * This is an internal function, use exec which uses the executor\n *\n * @param {Function} callback - Signature: err, results\n */\nCursor.prototype._exec = function(_callback) {\n  var res = [], added = 0, skipped = 0, self = this\n    , error = null\n    , i, keys, key\n    ;\n\n  function callback (error, res) {\n    if (self.execFn) {\n      return self.execFn(error, res, _callback);\n    } else {\n      return _callback(error, res);\n    }\n  }\n\n  this.db.getCandidates(this.query, function (err, candidates) {\n    if (err) { return callback(err); }\n\n    try {\n      for (i = 0; i < candidates.length; i += 1) {\n        if (model.match(candidates[i], self.query)) {\n          // If a sort is defined, wait for the results to be sorted before applying limit and skip\n          if (!self._sort) {\n            if (self._skip && self._skip > skipped) {\n              skipped += 1;\n            } else {\n              res.push(candidates[i]);\n              added += 1;\n              if (self._limit && self._limit <= added) { break; }\n            }\n          } else {\n            res.push(candidates[i]);\n          }\n        }\n      }\n    } catch (err) {\n      return callback(err);\n    }\n\n    // Apply all sorts\n    if (self._sort) {\n      keys = Object.keys(self._sort);\n\n      // Sorting\n      var criteria = [];\n      for (i = 0; i < keys.length; i++) {\n        key = keys[i];\n        criteria.push({ key: key, direction: self._sort[key] });\n      }\n      res.sort(function(a, b) {\n        var criterion, compare, i;\n        for (i = 0; i < criteria.length; i++) {\n          criterion = criteria[i];\n          compare = criterion.direction * model.compareThings(model.getDotValue(a, criterion.key), model.getDotValue(b, criterion.key), self.db.compareStrings);\n          if (compare !== 0) {\n            return compare;\n          }\n        }\n        return 0;\n      });\n\n      // Applying limit and skip\n      var limit = self._limit || res.length\n        , skip = self._skip || 0;\n\n      res = res.slice(skip, skip + limit);\n    }\n\n    // Apply projection\n    try {\n      res = self.project(res);\n    } catch (e) {\n      error = e;\n      res = undefined;\n    }\n\n    return callback(error, res);\n  });\n};\n\nCursor.prototype.exec = function () {\n  this.db.executor.push({ this: this, fn: this._exec, arguments: arguments });\n};\n\n\n\n// Interface\nmodule.exports = Cursor;\n"],"mappings":"AAAA;AACA;AACA;AACA,IAAIA,KAAK,GAAGC,OAAO,CAAC,SAAD,CAAnB;AAAA,IACIC,CAAC,GAAGD,OAAO,CAAC,YAAD,CADf;AAMA;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASE,MAAT,CAAiBC,EAAjB,EAAqBC,KAArB,EAA4BC,MAA5B,EAAoC;EAClC,KAAKF,EAAL,GAAUA,EAAV;EACA,KAAKC,KAAL,GAAaA,KAAK,IAAI,EAAtB;;EACA,IAAIC,MAAJ,EAAY;IAAE,KAAKA,MAAL,GAAcA,MAAd;EAAuB;AACtC;AAGD;AACA;AACA;;;AACAH,MAAM,CAACI,SAAP,CAAiBC,KAAjB,GAAyB,UAASA,KAAT,EAAgB;EACvC,KAAKC,MAAL,GAAcD,KAAd;EACA,OAAO,IAAP;AACD,CAHD;AAMA;AACA;AACA;;;AACAL,MAAM,CAACI,SAAP,CAAiBG,IAAjB,GAAwB,UAASA,IAAT,EAAe;EACrC,KAAKC,KAAL,GAAaD,IAAb;EACA,OAAO,IAAP;AACD,CAHD;AAMA;AACA;AACA;AACA;;;AACAP,MAAM,CAACI,SAAP,CAAiBK,IAAjB,GAAwB,UAASC,SAAT,EAAoB;EAC1C,KAAKC,KAAL,GAAaD,SAAb;EACA,OAAO,IAAP;AACD,CAHD;AAMA;AACA;AACA;AACA;AACA;;;AACAV,MAAM,CAACI,SAAP,CAAiBQ,UAAjB,GAA8B,UAASA,UAAT,EAAqB;EACjD,KAAKC,WAAL,GAAmBD,UAAnB;EACA,OAAO,IAAP;AACD,CAHD;AAMA;AACA;AACA;;;AACAZ,MAAM,CAACI,SAAP,CAAiBU,OAAjB,GAA2B,UAAUC,UAAV,EAAsB;EAC/C,IAAIC,GAAG,GAAG,EAAV;EAAA,IAAcC,IAAI,GAAG,IAArB;EAAA,IACIC,MADJ;EAAA,IACYC,MADZ;EAAA,IACoBC,IADpB;;EAIA,IAAI,KAAKP,WAAL,KAAqBQ,SAArB,IAAkCC,MAAM,CAACF,IAAP,CAAY,KAAKP,WAAjB,EAA8BU,MAA9B,KAAyC,CAA/E,EAAkF;IAChF,OAAOR,UAAP;EACD;;EAEDG,MAAM,GAAG,KAAKL,WAAL,CAAiBW,GAAjB,KAAyB,CAAzB,GAA6B,KAA7B,GAAqC,IAA9C;EACA,KAAKX,WAAL,GAAmBd,CAAC,CAAC0B,IAAF,CAAO,KAAKZ,WAAZ,EAAyB,KAAzB,CAAnB,CAV+C,CAY/C;;EACAO,IAAI,GAAGE,MAAM,CAACF,IAAP,CAAY,KAAKP,WAAjB,CAAP;EACAO,IAAI,CAACM,OAAL,CAAa,UAAUC,CAAV,EAAa;IACxB,IAAIR,MAAM,KAAKE,SAAX,IAAwBJ,IAAI,CAACJ,WAAL,CAAiBc,CAAjB,MAAwBR,MAApD,EAA4D;MAAE,MAAM,IAAIS,KAAJ,CAAU,gDAAV,CAAN;IAAoE;;IAClIT,MAAM,GAAGF,IAAI,CAACJ,WAAL,CAAiBc,CAAjB,CAAT;EACD,CAHD,EAd+C,CAmB/C;;EACAZ,UAAU,CAACW,OAAX,CAAmB,UAAUG,SAAV,EAAqB;IACtC,IAAIC,MAAJ;;IACA,IAAIX,MAAM,KAAK,CAAf,EAAkB;MAAI;MACpBW,MAAM,GAAG;QAAEC,IAAI,EAAE;MAAR,CAAT;MACAX,IAAI,CAACM,OAAL,CAAa,UAAUC,CAAV,EAAa;QACxBG,MAAM,CAACC,IAAP,CAAYJ,CAAZ,IAAiB9B,KAAK,CAACmC,WAAN,CAAkBH,SAAlB,EAA6BF,CAA7B,CAAjB;;QACA,IAAIG,MAAM,CAACC,IAAP,CAAYJ,CAAZ,MAAmBN,SAAvB,EAAkC;UAAE,OAAOS,MAAM,CAACC,IAAP,CAAYJ,CAAZ,CAAP;QAAwB;MAC7D,CAHD;MAIAG,MAAM,GAAGjC,KAAK,CAACoC,MAAN,CAAa,EAAb,EAAiBH,MAAjB,CAAT;IACD,CAPD,MAOO;MAAI;MACTA,MAAM,GAAG;QAAEI,MAAM,EAAE;MAAV,CAAT;MACAd,IAAI,CAACM,OAAL,CAAa,UAAUC,CAAV,EAAa;QAAEG,MAAM,CAACI,MAAP,CAAcP,CAAd,IAAmB,IAAnB;MAAyB,CAArD;MACAG,MAAM,GAAGjC,KAAK,CAACoC,MAAN,CAAaJ,SAAb,EAAwBC,MAAxB,CAAT;IACD;;IACD,IAAIZ,MAAJ,EAAY;MACVY,MAAM,CAACN,GAAP,GAAaK,SAAS,CAACL,GAAvB;IACD,CAFD,MAEO;MACL,OAAOM,MAAM,CAACN,GAAd;IACD;;IACDR,GAAG,CAACmB,IAAJ,CAASL,MAAT;EACD,CApBD;EAsBA,OAAOd,GAAP;AACD,CA3CD;AA8CA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACAhB,MAAM,CAACI,SAAP,CAAiBgC,KAAjB,GAAyB,UAASC,SAAT,EAAoB;EAC3C,IAAIrB,GAAG,GAAG,EAAV;EAAA,IAAcsB,KAAK,GAAG,CAAtB;EAAA,IAAyBC,OAAO,GAAG,CAAnC;EAAA,IAAsCtB,IAAI,GAAG,IAA7C;EAAA,IACIuB,KAAK,GAAG,IADZ;EAAA,IAEIC,CAFJ;EAAA,IAEOrB,IAFP;EAAA,IAEasB,GAFb;;EAKA,SAASC,QAAT,CAAmBH,KAAnB,EAA0BxB,GAA1B,EAA+B;IAC7B,IAAIC,IAAI,CAACd,MAAT,EAAiB;MACf,OAAOc,IAAI,CAACd,MAAL,CAAYqC,KAAZ,EAAmBxB,GAAnB,EAAwBqB,SAAxB,CAAP;IACD,CAFD,MAEO;MACL,OAAOA,SAAS,CAACG,KAAD,EAAQxB,GAAR,CAAhB;IACD;EACF;;EAED,KAAKf,EAAL,CAAQ2C,aAAR,CAAsB,KAAK1C,KAA3B,EAAkC,UAAU2C,GAAV,EAAe9B,UAAf,EAA2B;IAC3D,IAAI8B,GAAJ,EAAS;MAAE,OAAOF,QAAQ,CAACE,GAAD,CAAf;IAAuB;;IAElC,IAAI;MACF,KAAKJ,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG1B,UAAU,CAACQ,MAA3B,EAAmCkB,CAAC,IAAI,CAAxC,EAA2C;QACzC,IAAI5C,KAAK,CAACiD,KAAN,CAAY/B,UAAU,CAAC0B,CAAD,CAAtB,EAA2BxB,IAAI,CAACf,KAAhC,CAAJ,EAA4C;UAC1C;UACA,IAAI,CAACe,IAAI,CAACN,KAAV,EAAiB;YACf,IAAIM,IAAI,CAACT,KAAL,IAAcS,IAAI,CAACT,KAAL,GAAa+B,OAA/B,EAAwC;cACtCA,OAAO,IAAI,CAAX;YACD,CAFD,MAEO;cACLvB,GAAG,CAACmB,IAAJ,CAASpB,UAAU,CAAC0B,CAAD,CAAnB;cACAH,KAAK,IAAI,CAAT;;cACA,IAAIrB,IAAI,CAACX,MAAL,IAAeW,IAAI,CAACX,MAAL,IAAegC,KAAlC,EAAyC;gBAAE;cAAQ;YACpD;UACF,CARD,MAQO;YACLtB,GAAG,CAACmB,IAAJ,CAASpB,UAAU,CAAC0B,CAAD,CAAnB;UACD;QACF;MACF;IACF,CAjBD,CAiBE,OAAOI,GAAP,EAAY;MACZ,OAAOF,QAAQ,CAACE,GAAD,CAAf;IACD,CAtB0D,CAwB3D;;;IACA,IAAI5B,IAAI,CAACN,KAAT,EAAgB;MACdS,IAAI,GAAGE,MAAM,CAACF,IAAP,CAAYH,IAAI,CAACN,KAAjB,CAAP,CADc,CAGd;;MACA,IAAIoC,QAAQ,GAAG,EAAf;;MACA,KAAKN,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAGrB,IAAI,CAACG,MAArB,EAA6BkB,CAAC,EAA9B,EAAkC;QAChCC,GAAG,GAAGtB,IAAI,CAACqB,CAAD,CAAV;QACAM,QAAQ,CAACZ,IAAT,CAAc;UAAEO,GAAG,EAAEA,GAAP;UAAYM,SAAS,EAAE/B,IAAI,CAACN,KAAL,CAAW+B,GAAX;QAAvB,CAAd;MACD;;MACD1B,GAAG,CAACP,IAAJ,CAAS,UAASwC,CAAT,EAAYC,CAAZ,EAAe;QACtB,IAAIC,SAAJ,EAAeC,OAAf,EAAwBX,CAAxB;;QACA,KAAKA,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAGM,QAAQ,CAACxB,MAAzB,EAAiCkB,CAAC,EAAlC,EAAsC;UACpCU,SAAS,GAAGJ,QAAQ,CAACN,CAAD,CAApB;UACAW,OAAO,GAAGD,SAAS,CAACH,SAAV,GAAsBnD,KAAK,CAACwD,aAAN,CAAoBxD,KAAK,CAACmC,WAAN,CAAkBiB,CAAlB,EAAqBE,SAAS,CAACT,GAA/B,CAApB,EAAyD7C,KAAK,CAACmC,WAAN,CAAkBkB,CAAlB,EAAqBC,SAAS,CAACT,GAA/B,CAAzD,EAA8FzB,IAAI,CAAChB,EAAL,CAAQqD,cAAtG,CAAhC;;UACA,IAAIF,OAAO,KAAK,CAAhB,EAAmB;YACjB,OAAOA,OAAP;UACD;QACF;;QACD,OAAO,CAAP;MACD,CAVD,EATc,CAqBd;;MACA,IAAI/C,KAAK,GAAGY,IAAI,CAACX,MAAL,IAAeU,GAAG,CAACO,MAA/B;MAAA,IACIhB,IAAI,GAAGU,IAAI,CAACT,KAAL,IAAc,CADzB;MAGAQ,GAAG,GAAGA,GAAG,CAACuC,KAAJ,CAAUhD,IAAV,EAAgBA,IAAI,GAAGF,KAAvB,CAAN;IACD,CAnD0D,CAqD3D;;;IACA,IAAI;MACFW,GAAG,GAAGC,IAAI,CAACH,OAAL,CAAaE,GAAb,CAAN;IACD,CAFD,CAEE,OAAOwC,CAAP,EAAU;MACVhB,KAAK,GAAGgB,CAAR;MACAxC,GAAG,GAAGK,SAAN;IACD;;IAED,OAAOsB,QAAQ,CAACH,KAAD,EAAQxB,GAAR,CAAf;EACD,CA9DD;AA+DD,CA7ED;;AA+EAhB,MAAM,CAACI,SAAP,CAAiBqD,IAAjB,GAAwB,YAAY;EAClC,KAAKxD,EAAL,CAAQyD,QAAR,CAAiBvB,IAAjB,CAAsB;IAAEwB,IAAI,EAAE,IAAR;IAAcC,EAAE,EAAE,KAAKxB,KAAvB;IAA8ByB,SAAS,EAAEA;EAAzC,CAAtB;AACD,CAFD,C,CAMA;;;AACAC,MAAM,CAACC,OAAP,GAAiB/D,MAAjB"},"metadata":{},"sourceType":"script"}